<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayPal Subscription Tester</title>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width: 900px; margin: 36px auto; padding: 18px; color: #111; }
    h1 { font-size: 22px; margin-bottom: 6px; }
    p.lead { margin-top: 0; color: #444; }
    .card { border: 1px solid #e6e6e6; padding: 18px; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,0.03); margin-bottom: 16px; }
    label { display:block; margin-top:12px; font-weight:600; font-size:13px; }
    input[type="text"], select, textarea { width:100%; padding:10px; border-radius:6px; border:1px solid #ddd; margin-top:6px; box-sizing:border-box; }
    button { margin-top:16px; padding:10px 14px; border-radius:8px; border:0; cursor:pointer; font-weight:600; }
    button.primary { background:#0b76ef; color:white; }
    button.ghost { background:transparent; border:1px solid #ddd; color:#333; }
    .row { display:flex; gap:12px; }
    .col { flex:1; }
    pre { background:#f7f7f7; padding:12px; border-radius:6px; overflow:auto; }
    .muted { color:#666; font-size:13px; }
    .hint { font-size:13px; color:#555; margin-top:6px; }
    .result { margin-top:12px; padding:10px; border-radius:6px; background:#fbfbfb; border:1px solid #eee; font-size:14px; }
  </style>
</head>
<body>
  <h1>PayPal Subscription Tester</h1>
  <p class="lead">Quick frontend to call <code>POST /api/subscriptions/paypal/artist/:artistId</code>. Fill fields, provide your Bearer token, then Create Subscription → you'll be redirected to PayPal approval page.</p>

  <div class="card">
    <label>Backend Base URL</label>
    <input id="baseUrl" type="text" value="http://localhost:4000" />

    <label>Artist ID (Mongo ObjectId)</label>
    <input id="artistId" type="text" placeholder="e.g. 64f1a2b3c4d5e6f7a8b9c0d1" />

    <div class="row">
      <div class="col">
        <label>Cycle (plan cycle)</label>
        <select id="cycle">
          <option value="1m">1m</option>
          <option value="3m">3m</option>
          <option value="6m">6m</option>
          <option value="1y">1y</option>
        </select>
      </div>
      <div class="col">
        <label>Currency</label>
        <select id="currency">
          <option value="USD">USD</option>
          <option value="INR">INR</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
        </select>
      </div>
    </div>

    <label>Bearer Token (Authorization)</label>
    <input id="bearer" type="text" placeholder="Paste user JWT: Bearer <token> or just token" />

    <label>Optional: custom return URL (frontend)</label>
    <input id="returnUrl" type="text" placeholder="Optional: e.g. http://localhost:5173/paypal/sub-success" />

    <div style="display:flex; gap:8px;">
      <button class="primary" id="createBtn">Create Subscription</button>
      <button class="ghost" id="showLast">Show last response</button>
    </div>

    <div class="hint">
      Note: Your backend must allow requests from this origin (CORS) and authenticate the bearer JWT. If your middleware expects the header "Authorization: Bearer &lt;token&gt;", paste either the raw token or the full header.
    </div>

    <div class="result" id="result" style="display:none"></div>
  </div>

  <div class="card">
    <h3>How to use</h3>
    <ol class="muted">
      <li>Start your backend (e.g. <code>npm run dev</code>) on <code>http://localhost:4000</code>.</li>
      <li>Make sure your route is registered: <code>POST /api/subscriptions/paypal/artist/:artistId</code>.</li>
      <li>Paste a valid user JWT (or modify page to set a test cookie) so <code>authenticateUser</code> passes.</li>
      <li>Click <strong>Create Subscription</strong>. The page will open PayPal approve link in a new tab/window.</li>
      <li>Complete sandbox checkout using a PayPal sandbox buyer account; PayPal will redirect to the return URL set in your backend's plan creation (or the one from your server response).</li>
      <li>Make sure you also have a webhook endpoint on the server to mark subscription active on PayPal webhook events.</li>
    </ol>
  </div>

  <script>
    const createBtn = document.getElementById('createBtn');
    const showLast = document.getElementById('showLast');
    const resultEl = document.getElementById('result');

    let lastResponse = null;

    function showResult(obj) {
      resultEl.style.display = 'block';
      resultEl.innerHTML = '<pre>' + JSON.stringify(obj, null, 2) + '</pre>';
    }

    createBtn.addEventListener('click', async () => {
      resultEl.style.display = 'none';
      const baseUrl = document.getElementById('baseUrl').value.trim();
      const artistId = document.getElementById('artistId').value.trim();
      const cycle = document.getElementById('cycle').value;
      const currency = document.getElementById('currency').value;
      let bearer = document.getElementById('bearer').value.trim();
      const returnUrl = document.getElementById('returnUrl').value.trim();

      if (!artistId) {
        alert('Please provide artistId (from your DB).');
        return;
      }
      if (!baseUrl) {
        alert('Please provide backend base URL.');
        return;
      }

      // normalize token
      if (bearer && !bearer.toLowerCase().startsWith('bearer ')) {
        bearer = 'Bearer ' + bearer;
      }

      const endpoint = `${baseUrl}/api/subscriptions/paypal/artist/${encodeURIComponent(artistId)}`;

      const body = { cycle, currency };
      // optionally include return_url for server to use (if your controller reads it)
      if (returnUrl) body.returnUrl = returnUrl;

      try {
        const headers = {
          'Content-Type': 'application/json'
        };
        if (bearer) headers['Authorization'] = bearer;

        const res = await fetch(endpoint, {
          method: 'POST',
          headers,
          body: JSON.stringify(body),
        });

        const data = await res.json();
        lastResponse = { status: res.status, ok: res.ok, body: data };

        if (!res.ok) {
          showResult(lastResponse);
          alert('Server returned an error — see response below.');
          return;
        }

        showResult(lastResponse);

        // If approveUrl present, open it to continue PayPal flow
        const approveUrl = data.approveUrl || data.approveurl || data.approvalUrl || data.approveUrl;
        const subId = data.subscriptionId || data.subscription_id || data.subscriptionId;

        if (approveUrl) {
          // open in a new tab so user can complete the PayPal approval
          window.open(approveUrl, '_blank');
          alert('Approve URL opened in a new tab — complete PayPal checkout there.');
        } else {
          alert('No approveUrl returned from server. Check server response below.');
        }
      } catch (err) {
        lastResponse = { error: String(err) };
        showResult(lastResponse);
        alert('Network or code error — check the console and server logs.');
        console.error(err);
      }
    });

    showLast.addEventListener('click', () => {
      if (!lastResponse) {
        alert('No previous response yet.');
        return;
      }
      showResult(lastResponse);
    });
  </script>
</body>
</html>
